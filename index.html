<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è”µæ›¸ç®¡ç†ã‚¢ãƒ—ãƒª</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">ğŸ“š è”µæ›¸ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
  <div class="flex flex-col md:flex-row gap-4 mb-4">
    <div>
      <button id="startButton" class="bg-blue-500 text-white px-4 py-2 rounded mb-2">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
      <button id="stopButton" class="bg-red-500 text-white px-4 py-2 rounded mb-2">ã‚«ãƒ¡ãƒ©åœæ­¢</button>
      <button id="exportButton" class="bg-green-500 text-white px-4 py-2 rounded mb-2">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button id="importButton" class="bg-yellow-500 text-white px-4 py-2 rounded mb-2">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <input type="file" id="importFile" accept=".csv" class="hidden" />
      <div id="camera" class="border mt-4 w-64 h-48 overflow-hidden"></div>
    </div>
    <div class="flex-1">
      <h2 class="text-xl font-semibold mb-2">ç™»éŒ²æ¸ˆã¿æ›¸ç±</h2>
      <ul id="bookList" class="space-y-2"></ul>
    </div>
  </div>

  <script>
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const exportButton = document.getElementById('exportButton');
    const importButton = document.getElementById('importButton');
    const importFile = document.getElementById('importFile');
    const bookList = document.getElementById('bookList');

    // --- æ›¸ç±æƒ…å ±ã‚’å–å¾— ---
    async function fetchBookInfo(isbn) {
      const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
      const data = await response.json();
      if (data.totalItems > 0) {
        const item = data.items[0];
        const info = item.volumeInfo;
        const sale = item.saleInfo || {}; // â˜…è¿½åŠ 

        // â˜…å®šä¾¡æƒ…å ±ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ã€Œä¸æ˜ã€ï¼‰
        let price = 'ä¸æ˜';
        if (sale.listPrice && sale.listPrice.amount) {
          price = `${sale.listPrice.amount} ${sale.listPrice.currencyCode || 'JPY'}`;
        } else if (sale.retailPrice && sale.retailPrice.amount) {
          price = `${sale.retailPrice.amount} ${sale.retailPrice.currencyCode || 'JPY'}`;
        }

        return {
          isbn,
          title: info.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜',
          authors: (info.authors || ['è‘—è€…ä¸æ˜']).join(', '),
          price // â˜…è¿½åŠ 
        };
      }
      return null;
    }

    // --- æ›¸ç±ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º ---
    function renderBooks() {
      const books = JSON.parse(localStorage.getItem('books') || '[]');
      bookList.innerHTML = '';
      books.forEach((book, index) => {
        const li = document.createElement('li');
        li.className = 'bg-white p-4 rounded shadow flex justify-between items-center';
        li.innerHTML = `
          <div>
            <strong>${book.title}</strong><br>
            è‘—è€…: ${book.authors}<br>
            ISBN: ${book.isbn}<br>
            å®šä¾¡: ${book.price || 'ä¸æ˜'} <!-- â˜…è¿½åŠ  -->
          </div>
          <button onclick="deleteBook(${index})" class="bg-red-400 px-3 py-1 rounded text-white">å‰Šé™¤</button>`;
        bookList.appendChild(li);
      });
    }

    function deleteBook(index) {
      const books = JSON.parse(localStorage.getItem('books') || '[]');
      books.splice(index, 1);
      localStorage.setItem('books', JSON.stringify(books));
      renderBooks();
    }

    function addBook(book) {
      const books = JSON.parse(localStorage.getItem('books') || '[]');
      if (!books.find(b => b.isbn === book.isbn)) {
        books.unshift(book);
        localStorage.setItem('books', JSON.stringify(books));
        renderBooks();
      }
    }

    // --- CSVå‡ºåŠ›ã«å®šä¾¡ã‚‚è¿½åŠ  ---
    function exportToCSV() {
      const books = JSON.parse(localStorage.getItem('books') || '[]');
      const csvContent = 'ISBN,Title,Authors,Price\n' + books.map(b => 
        `${b.isbn},"${b.title}","${b.authors}","${b.price || ''}"`
      ).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'books.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // --- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å®šä¾¡ã‚‚å¯¾å¿œ ---
    function importFromCSV(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.trim().split('\n').slice(1);
        lines.forEach(line => {
          const [isbn, title, authors, price] = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s => s.replace(/^"|"$/g, '').trim());
          addBook({ isbn, title, authors, price });
        });
      };
      reader.readAsText(file);
    }

    // --- ã‚«ãƒ¡ãƒ©èµ·å‹•ã¨ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­å– ---
    startButton.addEventListener('click', () => {
      Quagga.init({
        inputStream: {
          name: 'Live',
          type: 'LiveStream',
          target: document.querySelector('#camera'),
          constraints: { width: 640, height: 480 }
        },
        decoder: { readers: ['ean_reader'] }
      }, err => {
        if (err) return console.error(err);
        Quagga.start();
      });

      Quagga.onDetected(async data => {
        const isbn = data.codeResult.code;
        if (/^97[89]\d{10}$/.test(isbn)) {
          Quagga.stop();
          const book = await fetchBookInfo(isbn);
          if (book) addBook(book);
        }
      });
    });

    stopButton.addEventListener('click', () => {
      Quagga.stop();
    });

    exportButton.addEventListener('click', exportToCSV);
    importButton.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) importFromCSV(file);
    });

    renderBooks();
  </script>
</body>
</html>
