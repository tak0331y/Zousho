<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>テニススコア管理アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-3xl mx-auto bg-white p-4 rounded-2xl shadow-xl">
    <h1 class="text-2xl font-bold mb-4 text-center">テニススコア管理アプリ</h1>

    <table class="table-auto w-full mb-4 border">
      <thead>
        <tr class="bg-gray-200">
          <th class="p-2 border">名前</th>
          <th class="p-2 border">セット</th>
          <th class="p-2 border">ゲーム</th>
          <th class="p-2 border">ポイント</th>
          <th class="p-2 border">操作</th>
        </tr>
      </thead>
      <tbody id="score-table">
        <!-- 動的に生成 -->
      </tbody>
    </table>

    <div class="text-center mb-4">
      <button onclick="undoPoint()" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-xl shadow">直近のポイントを削除</button>
    </div>

    <h2 class="text-xl font-semibold mb-2">履歴</h2>
    <ul id="history" class="space-y-1">
      <!-- 動的に履歴表示 -->
    </ul>

    <div class="text-center mt-6">
      <button onclick="resetAllData()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-xl shadow">全データのリセット</button>
    </div>
  </div>

  <script>
    const pointOrder = ['0', '15', '30', '40', 'アドバンテージ'];
    let score = {
      PlayerA: { set: 0, game: 0, point: 0, tiebreak: 0 },
      PlayerB: { set: 0, game: 0, point: 0, tiebreak: 0 },
      tiebreakMode: false
    };
    let history = [];
    let snapshots = [];

    function loadFromStorage() {
      const savedScore = localStorage.getItem('tennisScore');
      const savedHistory = localStorage.getItem('tennisHistory');
      const savedSnapshots = localStorage.getItem('tennisSnapshots');
      if (savedScore) score = JSON.parse(savedScore);
      if (savedHistory) history = JSON.parse(savedHistory);
      if (savedSnapshots) snapshots = JSON.parse(savedSnapshots);
      render();
    }

    function saveToStorage() {
      localStorage.setItem('tennisScore', JSON.stringify(score));
      localStorage.setItem('tennisHistory', JSON.stringify(history));
      localStorage.setItem('tennisSnapshots', JSON.stringify(snapshots));
    }

    function addPoint(player) {
      snapshots.push(JSON.stringify(score)); // スナップショット保存
      if (score.tiebreakMode) {
        score[player].tiebreak++;
        checkTiebreakWinner(player);
      } else {
        score[player].point++;
        updateGameSet(player);
      }
      addHistory(player);
      saveToStorage();
      render();
    }

    function updateGameSet(player) {
      const other = player === 'PlayerA' ? 'PlayerB' : 'PlayerA';
      const pPoint = score[player].point;
      const oPoint = score[other].point;

      if (pPoint >= 4) {
        if (pPoint - oPoint >= 2) {
          score[player].game++;
          score.PlayerA.point = 0;
          score.PlayerB.point = 0;

          if (score[player].game === 6 && score[other].game === 6) {
            score.tiebreakMode = true;
          } else if (score[player].game >= 6 && score[player].game - score[other].game >= 2) {
            score[player].set++;
            score.PlayerA.game = 0;
            score.PlayerB.game = 0;
          }
        }
      }
    }

    function checkTiebreakWinner(player) {
      const other = player === 'PlayerA' ? 'PlayerB' : 'PlayerA';
      const pPoint = score[player].tiebreak;
      const oPoint = score[other].tiebreak;

      if (pPoint >= 7 && pPoint - oPoint >= 2) {
        score[player].set++;
        score.PlayerA.game = 0;
        score.PlayerB.game = 0;
        score.PlayerA.tiebreak = 0;
        score.PlayerB.tiebreak = 0;
        score.tiebreakMode = false;
      }
    }

    function addHistory(player) {
      let pointDisplay;
      if (score.tiebreakMode) {
        pointDisplay = `タイブレーク：${score.PlayerA.tiebreak}-${score.PlayerB.tiebreak}`;
      } else {
        const pa = score.PlayerA.point;
        const pb = score.PlayerB.point;
        if (pa >= 3 && pb >= 3) {
          if (pa === pb) {
            pointDisplay = 'ポイント：40-40';
          } else {
            pointDisplay = `ポイント：${pa > pb ? 'アドバンテージ' : '40'}-${pb > pa ? 'アドバンテージ' : '40'}`;
          }
        } else {
          pointDisplay = `ポイント：${pointOrder[pa] || '0'}-${pointOrder[pb] || '0'}`;
        }
      }
      const entry = `${player}　セット：${score.PlayerA.set}-${score.PlayerB.set}　ゲーム：${score.PlayerA.game}-${score.PlayerB.game}　${pointDisplay}`;
      history.unshift(entry);
    }

    function undoPoint() {
      if (history.length > 0 && snapshots.length > 0) {
        history.shift();
        const previousState = JSON.parse(snapshots.pop());
        score = previousState;
        saveToStorage();
        render();
      }
    }

    function resetAllData() {
      if (confirm('全データをリセットしますか？')) {
        score = {
          PlayerA: { set: 0, game: 0, point: 0, tiebreak: 0 },
          PlayerB: { set: 0, game: 0, point: 0, tiebreak: 0 },
          tiebreakMode: false
        };
        history = [];
        snapshots = [];
        saveToStorage();
        location.reload();
      }
    }

    function render() {
      const table = document.getElementById('score-table');
      table.innerHTML = '';
      ['PlayerA', 'PlayerB'].forEach(player => {
        const other = player === 'PlayerA' ? 'PlayerB' : 'PlayerA';
        const row = document.createElement('tr');
        let pointValue;
        if (!score.tiebreakMode) {
          const pa = score[player].point;
          const pb = score[other].point;
          if (pa >= 3 && pb >= 3) {
            if (pa === pb) {
              pointValue = '40';
            } else {
              pointValue = pa > pb ? 'アドバンテージ' : '40';
            }
          } else {
            pointValue = pointOrder[pa] || '0';
          }
        } else {
          pointValue = score[player].tiebreak;
        }

        row.innerHTML = `
          <td class="p-2 border">${player}</td>
          <td class="p-2 border">${score[player].set}</td>
          <td class="p-2 border">${score[player].game}</td>
          <td class="p-2 border">${pointValue}</td>
          <td class="p-2 border text-center">
            <button onclick="addPoint('${player}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded-xl shadow">ポイント</button>
          </td>
        `;
        table.appendChild(row);
      });

      const historyList = document.getElementById('history');
      historyList.innerHTML = '';
      history.forEach(entry => {
        const li = document.createElement('li');
        li.textContent = entry;
        li.classList.add('bg-gray-200', 'p-2', 'rounded-xl', 'shadow');
        historyList.appendChild(li);
      });
    }

    window.onload = loadFromStorage;
  </script>
</body>
</html>
